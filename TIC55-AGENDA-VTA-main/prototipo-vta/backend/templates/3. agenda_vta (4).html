<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Agenda VTA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Reset e configurações básicas */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Paleta de cores VTA */
        :root {
            --vta-green: #52B788;
            --vta-green-light: #74C69D;
            --vta-green-dark: #40916C;
            --vta-blue: #2E86AB;
            --vta-blue-light: #48A3C7;
            --vta-blue-dark: #1B5E7A;
            --vta-orange: #F77F00;
            --vta-orange-light: #FCBF49;
            --vta-orange-dark: #D62828;
            --vta-purple: #9D4EDD;
            --vta-purple-light: #C77DFF;
            --white: #FFFFFF;
            --gray-light: #F8F9FA;
            --gray-medium: #6C757D;
            --gray-dark: #343A40;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--gray-light);
            color: var(--gray-dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--vta-green) 0%, var(--vta-green-dark) 100%);
            color: var(--white);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-mini {
            width: 45px;
            height: 45px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vta-green);
            font-size: 1.5rem;
        }

        .header-title h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--vta-green);
            font-weight: bold;
        }

        .user-details h3 {
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Main Container */
        .main-container {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 2rem;
            padding: 1.5rem 2rem;
            max-width: 100%;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            background: var(--white);
            border-radius: 15px;
            padding: 1rem 1.25rem;
            height: fit-content;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            width: 220px;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--gray-dark);
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, var(--vta-green) 0%, var(--vta-green-light) 100%);
            color: var(--white);
            transform: translateX(5px);
        }

        .nav-link i {
            font-size: 1.1rem;
            width: 20px;
        }

        /* Content Area */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Controles Superiores */
        .controls-section {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            background: var(--gray-light);
            border-radius: 8px;
            padding: 0.25rem;
        }

        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--gray-medium);
            min-width: 80px;
        }

        .view-btn.active {
            background: var(--white);
            color: var(--vta-green);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--gray-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray-medium);
        }

        .nav-btn:hover {
            background: var(--vta-green);
            color: var(--white);
        }

        .current-period {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-dark);
            min-width: 220px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--vta-green);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--vta-green-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--gray-dark);
        }

        .btn-secondary:hover {
            background: var(--gray-medium);
            color: var(--white);
        }

        .btn-danger {
            background: var(--vta-orange-dark);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #B91C1C;
            transform: translateY(-1px);
        }

        /* Grade de Agendamento */
        .agenda-grid {
            background: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .agenda-grid-scroll {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-inline: contain;
        }

        .grid-header {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            background: var(--vta-green);
            color: var(--white);
            font-weight: 600;

        }

        .grid-header.dia-view .grid-cell:nth-child(2) {
            background: var(--vta-green);
        }

        .grid-header.dia-view .grid-cell:nth-child(3) {
            background: var(--vta-blue);
        }

        .grid-header.dia-view .grid-cell:nth-child(4) {
            background: var(--vta-orange);
        }

        .grid-header.dia-view .grid-cell:nth-child(5) {
            background: var(--vta-purple);
        }


        .grid-cell {
            padding: 1rem;
            text-align: center;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .grid-cell:last-child {
            border-right: none;
        }

        .time-label {
            background: var(--vta-green-dark);
        }

        .sala-header {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sala-nome {
            font-size: 1rem;
        }

        .sala-status {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Visualização Semana */
        .week-grid-header {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            background: var(--vta-green);
            color: var(--white);
            font-weight: 600;
        }

        .week-grid-row {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            border-bottom: 1px solid var(--gray-light);
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                width: 100%;
            }
        }

        .week-grid-row:hover {
            background: rgba(82, 183, 136, 0.05);
        }

        .week-day-header {
            font-size: 0.9rem;
        }

        .dia-header {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .dia-nome {
            font-size: 0.95rem;
        }

        .dia-data {
            font-size: 0.75rem;
            opacity: 0.8;
        }


        /* Expansão de horários na visualização semanal */
        .appointment-cell.expandable {
            position: relative;
            overflow: visible;
        }

        .horarios-resumo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .horarios-resumo:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .contador-agendamentos {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }

        .icone-expandir {
            font-size: 0.8rem;
            color: var(--white);
            opacity: 0.8;
        }

        .horarios-expandidos {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            padding: 0;
        }

        .appointment-cell.expandable:hover .horarios-expandidos {
            max-height: 400px;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Estilo da barra de scroll para horários agendados */
        .horarios-expandidos::-webkit-scrollbar {
            width: 6px;
        }

        .horarios-expandidos::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 3px;
        }

        .horarios-expandidos::-webkit-scrollbar-thumb {
            background: var(--vta-green);
            border-radius: 3px;
        }

        .horarios-expandidos::-webkit-scrollbar-thumb:hover {
            background: var(--vta-green-dark);
        }

        /* Visualização de horários livres */
        .horarios-livres-lista {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.4s ease;
            padding: 0;
        }

        .appointment-cell.expandable:hover .horarios-livres-lista {
            max-height: 400px;
            padding: 1rem;
            overflow-y: auto;
        }

        /* Estilo da barra de scroll para horários livres */
        .horarios-livres-lista::-webkit-scrollbar {
            width: 6px;
        }

        .horarios-livres-lista::-webkit-scrollbar-track {
            background: var(--gray-light);
            border-radius: 3px;
        }

        .horarios-livres-lista::-webkit-scrollbar-thumb {
            background: var(--vta-blue);
            border-radius: 3px;
        }

        .horarios-livres-lista::-webkit-scrollbar-thumb:hover {
            background: var(--vta-blue-dark);
        }

        .horario-livre-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--gray-light);
            border-radius: 6px;
            border-left: 4px solid var(--vta-green);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .horario-livre-item:hover {
            background: var(--vta-green);
            color: var(--white);
            transform: translateX(5px);
        }

        .horario-livre-tempo {
            font-weight: 700;
            font-size: 1rem;
        }

        .horario-livre-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--vta-green);
        }

        .horario-livre-item:hover .horario-livre-status {
            color: var(--white);
        }

        .contador-livres {
            color: var(--vta-green);
        }

        .appointment-cell.expandable:hover .horarios-expandidos {
            max-height: 500px;
            padding: 1rem;
        }

        .horario-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--gray-light);
            border-radius: 6px;
            border-left: 4px solid var(--vta-green);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .horario-item:hover {
            background: var(--vta-green);
            color: var(--white);
            transform: translateX(5px);
        }

        .horario-item.sala1 {
            border-left-color: var(--vta-green);
        }

        .horario-item.sala2 {
            border-left-color: var(--vta-blue);
        }

        .horario-item.sala3 {
            border-left-color: var(--vta-orange);
        }

        .horario-item.sala4 {
            border-left-color: var(--vta-purple);
        }

        .horario-tempo {
            font-weight: 700;
            font-size: 1rem;
        }

        .horario-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .horario-pet {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .horario-cliente {
            font-size: 0.75rem;
            opacity: 0.7;
        }


        .horarios-resumo .icone-expandir:only-child {
            font-size: 1.5rem;
        }

        /* Visualização Mês */
        .calendar-day-header {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 1rem;
        }

        .calendar-body {
            background: var(--white);
        }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
        }

        .calendar-day {
            background: var(--white);
            min-height: 110px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #E5E7EB;
            position: relative;
        }

        .calendar-day::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: var(--gray-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-day:hover::before {
            border-color: var(--vta-green-light);
        }

        .calendar-day.other-month {
            opacity: 0.35;
            background: #FAFAFA;
        }

        .calendar-day.today {
            background: rgba(82, 183, 136, 0.1);
        }

        .calendar-day.today::before {
            border-color: var(--vta-green);
        }

        .day-number {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--gray-dark);
        }

        .day-events {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: auto;
            align-items: flex-end;
        }

        .event-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .event-badge.consulta {
            background: linear-gradient(135deg, var(--vta-green), var(--vta-green-light));
        }

        .event-badge.cirurgia {
            background: linear-gradient(135deg, var(--vta-blue), var(--vta-blue-light));
        }

        .event-badge.exame {
            background: linear-gradient(135deg, var(--vta-orange), var(--vta-orange-light));
        }

        .event-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .event-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--gray-dark);
            text-align: center;
            line-height: 1;
        }

        .event-badge.internacao {
            background: linear-gradient(135deg, var(--vta-purple), var(--vta-purple-light));
        }

        /* Grid Body */
        .grid-body {
            max-height: 600px;
            overflow-y: auto;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 100px repeat(4, 1fr);
            border-bottom: 1px solid var(--gray-light);
        }

        .grid-row:hover {
            background: rgba(82, 183, 136, 0.05);
        }

        .time-cell {
            padding: 1rem;
            text-align: center;
            background: var(--gray-light);
            font-weight: 500;
            color: var(--gray-medium);
            border-right: 1px solid var(--white);
        }

        .appointment-cell {
            padding: 0.5rem;
            border-right: 1px solid var(--gray-light);
            position: relative;
            min-height: 80px;
            cursor: pointer;
        }

        .appointment-cell:last-child {
            border-right: none;
        }

        .appointment-cell:hover {
            background: rgba(82, 183, 136, 0.1);
        }

        /* Agendamento */
        .appointment {
            color: var(--white);
            border-radius: 6px;
            padding: 0.6rem 0.75rem;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            cursor: move;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            position: relative;
        }

        .appointment-time {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .appointment-title {
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1.2;
        }

        .appointment-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
            line-height: 1.2;
        }

        .appointment-details {
            font-size: 0.75rem;
            opacity: 0.9;
        }


        /* Cores por sala */
        .appointment.sala1 {
            background: var(--vta-green);
        }

        .appointment.sala2 {
            background: var(--vta-blue);
        }

        .appointment.sala3 {
            background: var(--vta-orange);
        }

        .appointment.sala4 {
            background: var(--vta-purple);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 15px;
            padding: 0;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 2rem 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-light);
            position: sticky;
            top: 0;
            background: var(--white);
            z-index: 10;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-medium);
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--gray-dark);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 1.2rem;
            margin-top: 2.5rem;
        }

        .confirm-modal-content .modal-actions {
            gap: 1rem;
            margin-top: 0;
        }

        /* Modal de Detalhes */
        .detail-group {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .detail-group:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--gray-medium);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1.1rem;
            color: var(--gray-dark);
            font-weight: 500;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-badge.agendado {
            background: rgba(247, 127, 0, 0.1);
            color: var(--vta-orange);
        }

        .status-badge.confirmado {
            background: rgba(82, 183, 136, 0.1);
            color: var(--vta-green);
        }

        .status-badge.realizado {
            background: rgba(46, 134, 171, 0.1);
            color: var(--vta-blue);
        }

        .status-badge.cancelado {
            background: rgba(214, 40, 40, 0.1);
            color: var(--vta-orange-dark);
        }

        .status-badge.checkin {
            background: linear-gradient(135deg, #52B788, #74C69D);
            color: var(--white);
            font-weight: 600;
        }

        /* Estilo para agendamento com check-in */
        .appointment.checkin-realizado {
            background: linear-gradient(135deg, #52B788, #74C69D) !important;
            box-shadow: 0 4px 12px rgba(82, 183, 136, 0.3);
            border: 2px solid #40916C;
        }

        .appointment.checkin-realizado::before {
            content: '✓';
            position: absolute;
            top: 0.25rem;
            right: 0.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--white);
        }

        /* Botão de exclusão estilo X vermelho */
        .btn-delete-checkin {
            background: linear-gradient(135deg, #D62828, #FF6B6B) !important;
            color: var(--white) !important;
            padding: 0.75rem 1.5rem !important;
        }

        .btn-delete-checkin:hover {
            background: linear-gradient(135deg, #B91C1C, #D62828) !important;
            transform: translateY(-1px);
        }

        .btn-delete-checkin i::before {
            content: '✕' !important;
            font-size: 1.3rem;
            font-weight: bold;
        }

        /* Modal de Confirmação */
        .confirm-modal-content {
            max-width: 450px;
            text-align: center;
            padding: 2.5rem 2rem;
        }

        .confirm-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
            background: linear-gradient(135deg, rgba(214, 40, 40, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.8rem;
            color: #D62828;
            box-shadow: 0 4px 12px rgba(214, 40, 40, 0.15);
        }

        .confirm-icon.warning {
            background: linear-gradient(135deg, rgba(247, 127, 0, 0.1), rgba(252, 191, 73, 0.1));
            color: var(--vta-orange);
            box-shadow: 0 4px 12px rgba(247, 127, 0, 0.15);
        }

        .confirm-icon.success {
            background: linear-gradient(135deg, rgba(82, 183, 136, 0.1), rgba(116, 198, 157, 0.1));
            color: var(--vta-green);
            box-shadow: 0 4px 12px rgba(82, 183, 136, 0.15);
        }

        /* Indicador visual aprimorado para check-in realizado */
        .appointment.checkin-realizado .appointment-checkin-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #40916C, #52B788);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(64, 145, 108, 0.4);
            border: 2px solid white;
            animation: pulseCheckin 2s ease-in-out infinite;
        }

        @keyframes pulseCheckin {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .confirm-message {
            font-size: 1.4rem;
            color: var(--gray-dark);
            margin-bottom: 0.75rem;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .confirm-submessage {
            font-size: 0.95rem;
            color: var(--gray-medium);
            margin-bottom: 2.5rem;
            line-height: 1.5;
        }

        .info-box {
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
            padding: 1.5rem;
            border-radius: 10px;
            margin: 1.5rem 0 2rem 0;
            text-align: left;
            border-left: 4px solid var(--vta-orange);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .info-box-title {
            font-weight: 700;
            color: var(--gray-dark);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--vta-orange);
        }

        .info-box-text {
            font-size: 0.95rem;
            color: var(--gray-dark);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .info-box-text:last-child {
            margin-bottom: 0;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                width: 100%;
            }

            .grid-header,
            .grid-row {
                grid-template-columns: 80px repeat(4, 1fr);
            }

            .week-grid-header,
            .week-grid-row {
                grid-template-columns: 80px repeat(5, 1fr);
            }
        }

        /* Versão mobile: visual mais "app" */
        @media (max-width: 768px) {
            body {
                background: linear-gradient(180deg, var(--vta-green) 0%, var(--gray-light) 45%);
                padding-bottom: 2rem;
            }

            .header {
                padding: 0.9rem 1.25rem;
                width: 100%;
                margin: 0;
                border-radius: 0;
            }

            .header-content {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
                align-items: center;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .user-details {
                display: none;
            }

            .main-container {
                grid-template-columns: 1fr;
                padding: 1rem 1.25rem 1.5rem;
                gap: 1.25rem;
                max-width: 480px;
                margin: 0 auto;
            }

            .sidebar {
                width: 100%;
                max-width: 480px;
                margin: 0.5rem auto 0;
                padding: 0.9rem 0.9rem;
                background: var(--white);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
                border-radius: 15px;
            }

            .sidebar-section {
                margin-bottom: 1rem;
            }

            .sidebar-title {
                text-align: center;
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .nav-menu {
                display: block;
                padding: 0;
            }

            .nav-item {
                margin: 0 0 0.5rem 0;
            }

            .nav-link {
                padding: 0.55rem 0.75rem;
                font-size: 0.9rem;
                border-radius: 10px;
                background: transparent;
                border: none;
                box-shadow: none;
            }

            .content-area {
                max-width: 480px;
                width: 100%;
                margin: 0 auto;
            }

            .controls-section {
                padding: 1.25rem 1.1rem;
                border: 1px solid rgba(82, 183, 136, 0.1);
            }

            .view-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 0.9rem;
            }

            .view-toggle {
                justify-content: space-between;
                border: 1px solid rgba(82, 183, 136, 0.15);
            }

            .view-btn {
                flex: 1;
                text-align: center;
            }

            .date-navigation {
                justify-content: space-between;
            }

            .current-period {
                font-size: 1rem;
                min-width: auto;
            }

            .action-buttons {
                flex-wrap: wrap;
                justify-content: stretch;
            }

            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }

            .agenda-grid {
                border-radius: 18px;
            }

            .agenda-grid-scroll {
                padding-bottom: 0.5rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-inline: contain;
            }

            .grid-header,
            .grid-row {
                min-width: 640px;
                grid-template-columns: 90px repeat(4, minmax(130px, 1fr));
            }

            .grid-body {
                max-height: 60vh;
            }

            .grid-cell {
                padding: 0.75rem 0.45rem;
                font-size: 0.8rem;
            }

            .time-cell {
                padding: 0.75rem 0.45rem;
                font-size: 0.75rem;
            }

            .appointment-cell {
                min-height: 65px;
            }

            .appointment-title {
                font-size: 0.9rem;
            }

            .appointment-subtitle,
            .appointment-details {
                font-size: 0.7rem;
            }

            .calendar-day {
                min-height: 90px;
                padding: 0.6rem;
            }
        }

        /* Celulares menores */
        @media (max-width: 576px) {
            .header-title h1 {
                font-size: 1.5rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
            }

            .logo-mini {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .main-container {
                padding: 0.9rem 1rem 1.3rem;
            }

            .controls-section {
                padding: 1.1rem 1rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.6rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .grid-body {
                max-height: 65vh;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.5rem;
            }

            .day-number {
                font-size: 1rem;
            }

            .event-badge {
                min-width: 20px;
                height: 20px;
                font-size: 0.7rem;
            }

            .modal {
                align-items: flex-end;
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                max-height: 90vh;
                border-radius: 18px 18px 0 0;
                margin: 0;
            }

            .modal-header {
                padding: 1.4rem 1.4rem 1rem 1.4rem;
            }

            .modal-body {
                padding: 1.4rem;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-mini">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="header-title">
                    <h1>Agenda VTA</h1>
                    <div class="header-subtitle">Sistema de Agendamento Veterinário</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div class="user-details">
                        <h3>Administrador</h3>
                        <p class="user-role">admin@vta.com</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()" title="Sair do sistema" style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: 1rem;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Menu Principal</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="{{ url_for("dashboard") }}" class="nav-link">
                            <i class="fas fa-chart-pie"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("agenda_page") }}" class="nav-link active"
                                       onclick='window.location.href="{{ url_for("agenda_page") }}"; return false;'>
                            <i class="fas fa-calendar"></i>
                            Agenda
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("agendamento_page") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("agendamento_page") }}"; return false;'>
                            <i class="fas fa-plus-circle"></i>
                            Novo Agendamento
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("clientes_page") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("clientes_page") }}"; return false;'>
                            <i class="fas fa-users"></i>
                            Clientes
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("pets_page") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("pets_page") }}"; return false;'>
                            <i class="fas fa-paw"></i>
                            Pets
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("salas_page") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("salas_page") }}"; return false;'>
                            <i class="fas fa-door-open"></i>
                            Salas
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3 class="sidebar-title">Administração</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                                <a href="{{ url_for("relatorios_dashboard") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("relatorios_dashboard") }}"; return false;'>
                            <i class="fas fa-chart-bar"></i>
                            Relatórios ADM
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("relatorios_pets") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("relatorios_pets") }}"; return false;'>
                            <i class="fas fa-file-medical"></i>
                            Histórico Pets
                        </a>
                    </li>
                    <li class="nav-item">
                                <a href="{{ url_for("usuarios_page") }}" class="nav-link"
                                       onclick='window.location.href="{{ url_for("usuarios_page") }}"; return false;'>
                            <i class="fas fa-user-cog"></i>
                            Usuários
                        </a>
                    </li>
                </ul>
            </div>
        </aside>

        <div class="content-area">
            <div class="controls-section">
                <div class="view-controls">
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="dia">Dia</button>
                        <button class="view-btn" data-view="semana">Semana</button>
                        <button class="view-btn" data-view="mes">Mês</button>
                    </div>

                    <div class="date-navigation">
                        <button class="nav-btn" onclick="navegarPeriodo(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="current-period" id="currentPeriod">Quarta, 10 de Outubro 2024</span>
                        <button class="nav-btn" onclick="navegarPeriodo(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="irParaHoje()">
                            <i class="fas fa-calendar-day"></i>
                            Hoje
                        </button>
                        <button class="btn btn-primary" onclick="novoAgendamento()">
                            <i class="fas fa-plus"></i>
                            Novo
                        </button>
                        <button class="btn btn-secondary" onclick="buscarAgendamento()">
                            <i class="fas fa-search"></i>
                            Buscar
                        </button>
                        <button class="btn btn-secondary" id="btnVisualizacao"
                            onclick="alternarVisualizacao()" style="min-width: 180px;">
                            <i class="fas fa-eye"></i>
                            <span id="textoVisualizacao">Horários Livres</span>
                        </button>
                        <button class="btn btn-secondary" onclick="imprimirAgendamentos()">
                            <i class="fas fa-print"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
            </div>

            <div class="agenda-grid">
                <div class="agenda-grid-scroll">
                    <div class="grid-header" id="gridHeader">
                        <!-- Header será preenchido dinamicamente -->
                    </div>

                    <div class="grid-body" id="agendaGridBody">
                        <!-- Grid será preenchido dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Agendamento -->
    <div class="modal" id="agendamentoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Novo Agendamento</h3>
                <button class="close-btn" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="agendamentoForm">
                    <div class="form-group">
                        <label>Cliente:</label>
                        <select id="clienteSelect" required>
                            <option value="">Selecione um cliente</option>
                            <!-- Clientes serão carregados do banco de dados -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pet:</label>
                        <select id="petSelect" required>
                            <option value="">Selecione um pet</option>
                            <!-- Pets serão carregados ao selecionar um cliente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sala:</label>
                        <select id="salaSelect" required>
                            <option value="">Selecione uma sala</option>
                            <!-- Salas serão carregadas dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Profissional:</label>
                        <select id="profissionalSelect">
                            <option value="">Selecione um profissional (opcional)</option>
                            <!-- Profissionais serão carregados dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data e Hora:</label>
                        <input type="datetime-local" id="dataHoraInput" required>
                    </div>
                    <div class="form-group">
                        <label>Observações:</label>
                        <textarea id="obsTextarea" placeholder="Observações sobre o atendimento"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharModal()" style="flex: 1;">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary" id="btnEditarAgendamento" onclick="abrirEdicao()"
                            style="flex: 1; display: none;">
                            <i class="fas fa-edit"></i>
                            Editar
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div class="modal" id="detalhesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes do Agendamento</h3>
                <button class="close-btn" onclick="fecharDetalhes()">&times;</button>
            </div>
            <div class="modal-body" id="detalhesContent">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal" id="confirmarExclusaoModal">
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-message">Confirmar Exclusão</h3>
            <p class="confirm-submessage">Esta ação não pode ser desfeita!</p>
            <div class="info-box" id="confirmInfoBox">
                <!-- Informações do agendamento -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="fecharConfirmacao()" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-danger" onclick="confirmarExclusao()" style="flex: 1;">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Movimentação -->
    <div class="modal" id="confirmarMoverModal">
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon warning">
                <i class="fas fa-arrows-alt"></i>
            </div>
            <h3 class="confirm-message">Confirmar Movimentação</h3>
            <p class="confirm-submessage">Deseja mover este agendamento?</p>
            <div class="info-box" id="moverInfoBox">
                <!-- Informações da movimentação -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cancelarMovimentacao()" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="confirmarMovimentacao()" style="flex: 1;">
                    <i class="fas fa-check"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Check-in -->
    <div class="modal" id="confirmarCheckinModal">
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="confirm-message">Confirmar Check-in</h3>
            <p class="confirm-submessage">Registrar chegada do paciente?</p>
            <div class="info-box" id="checkinInfoBox">
                <!-- Informações do agendamento -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="fecharConfirmacaoCheckin()" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="confirmarCheckinReal()" style="background: linear-gradient(135deg, #52B788, #74C69D); flex: 1;">
                    <i class="fas fa-check"></i>
                    Confirmar Check-in
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Busca -->
    <div class="modal" id="buscarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Buscar Agendamento</h3>
                <button class="close-btn" onclick="fecharBuscar()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="buscarForm" onsubmit="event.preventDefault(); realizarBusca();">
                    <div class="form-group">
                        <label>Cliente ou Pet:</label>
                        <input type="text" id="buscaInput" placeholder="Digite o nome do cliente ou pet">
                    </div>
                    <div class="form-group">
                        <label>Sala:</label>
                        <select id="buscaSalaSelect">
                            <option value="">Todas as Salas</option>
                            <option value="sala1">Sala 1 - Consulta</option>
                            <option value="sala2">Sala 2 - Cirurgia</option>
                            <option value="sala3">Sala 3 - Raio-X</option>
                            <option value="sala4">Sala 4 - Internação</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data:</label>
                        <input type="date" id="buscaDataInput">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="fecharBuscar()" style="flex: 1;">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-search"></i>
                            Buscar
                        </button>
                    </div>
                </form>
                <div id="resultadosBusca" style="margin-top: 1.5rem; display: none;">
                    <h4 style="margin-bottom: 1rem; color: var(--gray-dark);">Resultados:</h4>
                    <div id="listaResultados"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let estadoAtual = {
            visualizacao: 'dia',
            dataAtual: new Date(),
            salaFiltro: 'todas'
        };

        let agendamentos = []; // Inicialmente vazio, carregado do backend
        let clientesDisponiveis = []; // Lista de clientes do banco de dados
        let profissionaisDisponiveis = []; // Lista de profissionais

        // Salas configuráveis - podem ser carregadas do backend futuramente
        let salasDisponiveis = [
            { id: 'sala1', nome: 'Sala 1', tipo: 'Consulta', cor: 'var(--vta-green)', profissional: '' },
            { id: 'sala2', nome: 'Sala 2', tipo: 'Cirurgia', cor: 'var(--vta-blue)', profissional: '' },
            { id: 'sala3', nome: 'Sala 3', tipo: 'Raio-X', cor: 'var(--vta-orange)', profissional: '' },
            { id: 'sala4', nome: 'Sala 4', tipo: 'Internação', cor: 'var(--vta-purple)', profissional: '' }
        ];

        let proximoId = 0; // Gerado pelo backend
        let agendamentoParaExcluir = null;
        let agendamentoParaCheckin = null;
        let agendamentoEditando = null;
        let movimentacaoPendente = null;
        let modoVisualizacao = 'agendados'; // 'agendados' ou 'livres' - funciona para dia e semana

        // Função para normalizar horário quebrado para o slot mais próximo de 30 minutos
        function normalizarHorarioParaSlot(horario) {
            const [hora, minuto] = horario.split(':').map(Number);
            const minutoNormalizado = minuto < 15 ? '00' : minuto < 45 ? '30' : '00';
            const horaNormalizada = minuto >= 45 ? hora + 1 : hora;
            return `${horaNormalizada.toString().padStart(2, '0')}:${minutoNormalizado}`;
        }

        // Função para obter cor da sala
        function getCorSala(salaId) {
            const sala = salasDisponiveis.find(s => s.id === salaId);
            return sala ? sala.cor : 'var(--vta-green)';
        }

        // Função para verificar se sala está em uso no momento atual
        function verificarSalaEmUso(salaId) {
            const agora = new Date();
            const horaAtual = `${agora.getHours().toString().padStart(2, '0')}:${agora.getMinutes().toString().padStart(2, '0')}`;

            return agendamentos.some(a => {
                if (a.sala !== salaId || a.status === 'cancelado') return false;
                if (!mesmaData(a.data, agora)) return false;

                // Verifica se o horário atual está dentro do período do agendamento (30 min)
                const [horaAg, minAg] = a.horario.split(':').map(Number);
                const [horaAt, minAt] = horaAtual.split(':').map(Number);

                const inicioMin = horaAg * 60 + minAg;
                const fimMin = inicioMin + 30;
                const atualMin = horaAt * 60 + minAt;

                return atualMin >= inicioMin && atualMin < fimMin;
            });
        }

        // Função para obter status da sala
        function getStatusSala(salaId) {
            if (verificarSalaEmUso(salaId)) {
                return { texto: 'Em Uso', classe: 'em-uso' };
            }
            return { texto: 'Disponível', classe: 'disponivel' };
        }

        // Função para carregar clientes do backend
        async function carregarClientes() {
            try {
                const response = await fetch('/api/clientes');
                if (!response.ok) throw new Error('Erro ao carregar clientes');

                clientesDisponiveis = await response.json();
                atualizarSelectClientes();
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                // Se o endpoint não existir, mantém a lista vazia
                clientesDisponiveis = [];
                atualizarSelectClientes();
            }
        }

        // Função para atualizar o select de clientes
        function atualizarSelectClientes() {
            const clienteSelect = document.getElementById('clienteSelect');
            clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';

            clientesDisponiveis.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                option.textContent = cliente.nome;
                option.dataset.clienteId = cliente.id;
                clienteSelect.appendChild(option);
            });

            if (clientesDisponiveis.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Nenhum cliente cadastrado";
                option.disabled = true;
                clienteSelect.appendChild(option);
            }
        }

        // Função para carregar pets de um cliente específico
        async function carregarPetsDoCliente(clienteNome) {
            const petSelect = document.getElementById('petSelect');
            petSelect.innerHTML = '<option value="">Selecione um pet</option>';

            if (!clienteNome) return;

            try {
                // Busca pets do cliente selecionado
                const response = await fetch(`/api/pets?cliente=${encodeURIComponent(clienteNome)}`);
                if (!response.ok) throw new Error('Erro ao carregar pets');

                const pets = await response.json();

                pets.forEach(pet => {
                    const option = document.createElement('option');
                    option.value = pet.nome;
                    option.textContent = `${pet.nome} (${pet.especie || 'Pet'})`;
                    option.dataset.petId = pet.id;
                    petSelect.appendChild(option);
                });

                if (pets.length === 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.textContent = "Nenhum pet cadastrado para este cliente";
                    option.disabled = true;
                    petSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Erro ao carregar pets:', error);
            }
        }

        // Função para carregar salas do backend (ou usar padrão)
        async function carregarSalas() {
            try {
                const response = await fetch('/api/salas');
                if (response.ok) {
                    const salas = await response.json();
                    if (salas.length > 0) {
                        salasDisponiveis = salas.map((s, i) => ({
                            id: s.id || `sala${i + 1}`,
                            nome: s.nome || `Sala ${i + 1}`,
                            tipo: s.tipo || 'Geral',
                            cor: s.cor || ['var(--vta-green)', 'var(--vta-blue)', 'var(--vta-orange)', 'var(--vta-purple)'][i % 4],
                            profissional: s.profissional || ''
                        }));
                    }
                }
            } catch (error) {
                console.log('Usando salas padrão');
            }
            atualizarSelectSalas();
        }

        // Função para atualizar o select de salas
        function atualizarSelectSalas() {
            const salaSelect = document.getElementById('salaSelect');
            salaSelect.innerHTML = '<option value="">Selecione uma sala</option>';

            salasDisponiveis.forEach(sala => {
                const option = document.createElement('option');
                option.value = sala.id;
                option.textContent = `${sala.nome} - ${sala.tipo}`;
                salaSelect.appendChild(option);
            });
        }

        // Função para carregar profissionais do backend
        async function carregarProfissionais() {
            try {
                const response = await fetch('/api/profissionais');
                if (response.ok) {
                    profissionaisDisponiveis = await response.json();
                    atualizarSelectProfissionais();
                }
            } catch (error) {
                console.log('Sem profissionais cadastrados');
            }
        }

        // Função para atualizar o select de profissionais
        function atualizarSelectProfissionais() {
            const profSelect = document.getElementById('profissionalSelect');
            profSelect.innerHTML = '<option value="">Selecione um profissional (opcional)</option>';

            profissionaisDisponiveis.forEach(prof => {
                const option = document.createElement('option');
                option.value = prof.nome || prof.id;
                option.textContent = prof.nome;
                profSelect.appendChild(option);
            });
        }

        // Event listener para quando o cliente é selecionado
        document.addEventListener('DOMContentLoaded', function() {
            const clienteSelect = document.getElementById('clienteSelect');
            clienteSelect.addEventListener('change', function() {
                carregarPetsDoCliente(this.value);
            });

            // Carregar dados ao iniciar
            carregarClientes();
            carregarSalas();
            carregarProfissionais();
        });

        // Função para carregar agendamentos do backend
        async function carregarAgendamentos() {
            try {
                const response = await fetch('/api/agendamentos');
                if (!response.ok) throw new Error('Erro ao carregar agendamentos');
                
                const dados = await response.json();
                
                // Converter strings de data para objetos Date
                agendamentos = dados.map(a => ({
                    ...a,
                    data: new Date(a.data + 'T00:00:00'), // Ajuste para garantir data correta
                    // O backend retorna HH:MM, o frontend espera isso mesmo
                }));
                
                renderizarGrade();
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao carregar agendamentos', 'error');
            }
        }

        // Função salvarAgendamentos removida pois agora salvamos diretamente no backend a cada ação

        function gerarHorarios() {
            const horarios = [];
            for (let hora = 8; hora < 18; hora++) {
                horarios.push(`${hora.toString().padStart(2, '0')}:00`);
                horarios.push(`${hora.toString().padStart(2, '0')}:30`);
            }
            return horarios;
        }

        function mesmaData(data1, data2) {
            return data1.getDate() === data2.getDate() &&
                data1.getMonth() === data2.getMonth() &&
                data1.getFullYear() === data2.getFullYear();
        }

        function getInicioSemana(data) {
            const d = new Date(data);
            const dia = d.getDay();
            const diff = d.getDate() - dia; // Ajuste para domingo ser 0
            // Se domingo for o primeiro dia da semana no calendário, ok.
            // Se for segunda, precisa ajustar. O código original usava getDay() direto.
            return new Date(d.setDate(diff));
        }

        function atualizarPeriodo() {
            const periodoElement = document.getElementById('currentPeriod');
            const opcoes = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };

            switch (estadoAtual.visualizacao) {
                case 'dia':
                    periodoElement.textContent = estadoAtual.dataAtual.toLocaleDateString('pt-BR', opcoes);
                    break;
                case 'semana':
                    const inicioSemana = getInicioSemana(estadoAtual.dataAtual);
                    const fimSemana = new Date(inicioSemana);
                    fimSemana.setDate(inicioSemana.getDate() + 6);
                    periodoElement.textContent = `${inicioSemana.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' })} - ${fimSemana.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' })}`;
                    break;
                case 'mes':
                    periodoElement.textContent = estadoAtual.dataAtual.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long' });
                    break;
            }
        }

        function navegarPeriodo(direcao) {
            const novaData = new Date(estadoAtual.dataAtual);

            switch (estadoAtual.visualizacao) {
                case 'dia':
                    novaData.setDate(estadoAtual.dataAtual.getDate() + direcao);
                    break;
                case 'semana':
                    novaData.setDate(estadoAtual.dataAtual.getDate() + (direcao * 7));
                    break;
                case 'mes':
                    novaData.setMonth(estadoAtual.dataAtual.getMonth() + direcao);
                    break;
            }

            estadoAtual.dataAtual = novaData;
            atualizarPeriodo();
            renderizarGrade();
        }

        function irParaHoje() {
            estadoAtual.dataAtual = new Date();
            atualizarPeriodo();
            renderizarGrade();
            mostrarToast('Voltou para hoje!', 'success');
        }

        function renderizarGrade() {
            // Atualizar texto do botão de visualização
            const textoVisualizacao = document.getElementById('textoVisualizacao');
            if (textoVisualizacao) {
                textoVisualizacao.textContent = modoVisualizacao === 'agendados' ? 'Horários Livres' : 'Horários Agendados';
            }

            switch (estadoAtual.visualizacao) {
                case 'dia':
                    renderizarGradeDia();
                    break;
                case 'semana':
                    renderizarGradeSemana();
                    break;
                case 'mes':
                    renderizarGradeMes();
                    break;
            }
        }

        // Função unificada para alternar visualização (dia e semana)
        function alternarVisualizacao() {
            if (modoVisualizacao === 'agendados') {
                modoVisualizacao = 'livres';
                mostrarToast('Mostrando horários livres', 'info');
            } else {
                modoVisualizacao = 'agendados';
                mostrarToast('Mostrando horários agendados', 'info');
            }
            renderizarGrade();
        }

        // Função para imprimir agendamentos
        function imprimirAgendamentos() {
            const printWindow = window.open('', '_blank');
            const dataFormatada = estadoAtual.dataAtual.toLocaleDateString('pt-BR', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            let agendamentosFiltrados = [];
            if (estadoAtual.visualizacao === 'dia') {
                agendamentosFiltrados = agendamentos.filter(a =>
                    mesmaData(a.data, estadoAtual.dataAtual) && a.status !== 'cancelado'
                );
            } else if (estadoAtual.visualizacao === 'semana') {
                const inicioSemana = getInicioSemana(estadoAtual.dataAtual);
                const fimSemana = new Date(inicioSemana);
                fimSemana.setDate(inicioSemana.getDate() + 6);
                agendamentosFiltrados = agendamentos.filter(a =>
                    a.data >= inicioSemana && a.data <= fimSemana && a.status !== 'cancelado'
                );
            } else {
                const mes = estadoAtual.dataAtual.getMonth();
                const ano = estadoAtual.dataAtual.getFullYear();
                agendamentosFiltrados = agendamentos.filter(a =>
                    a.data.getMonth() === mes && a.data.getFullYear() === ano && a.status !== 'cancelado'
                );
            }

            agendamentosFiltrados.sort((a, b) => {
                const dataCompare = a.data - b.data;
                if (dataCompare !== 0) return dataCompare;
                return a.horario.localeCompare(b.horario);
            });

            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Agendamentos - ${dataFormatada}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #52B788; border-bottom: 2px solid #52B788; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #52B788; color: white; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .status-agendado { color: #F77F00; }
                        .status-confirmado { color: #52B788; }
                        .status-checkin { color: #2E86AB; font-weight: bold; }
                        @media print { body { padding: 0; } }
                    </style>
                </head>
                <body>
                    <h1>Agenda VTA - ${dataFormatada}</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Horário</th>
                                <th>Cliente</th>
                                <th>Pet</th>
                                <th>Sala</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            agendamentosFiltrados.forEach(a => {
                const temCheckin = a.checkin && a.checkin.realizado;
                const statusClasse = temCheckin ? 'status-checkin' : `status-${a.status}`;
                const statusTexto = temCheckin ? 'CHECK-IN ✓' : a.status.toUpperCase();
                html += `
                    <tr>
                        <td>${a.data.toLocaleDateString('pt-BR')}</td>
                        <td>${a.horario}</td>
                        <td>${a.cliente}</td>
                        <td>${a.pet}</td>
                        <td>${getNomeSala(a.sala)}</td>
                        <td class="${statusClasse}">${statusTexto}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                    <p style="margin-top: 20px; color: #666;">Total: ${agendamentosFiltrados.length} agendamento(s)</p>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }

        function renderizarGradeDia() {
            const gridHeader = document.getElementById('gridHeader');
            const gridBody = document.getElementById('agendaGridBody');
            const horarios = gerarHorarios();
            const numSalas = salasDisponiveis.length;

            gridBody.className = 'grid-body';

            // Header dinâmico baseado nas salas disponíveis
            gridHeader.className = 'grid-header dia-view';
            gridHeader.style.display = 'grid';
            gridHeader.style.gridTemplateColumns = `100px repeat(${numSalas}, 1fr)`;

            let headerHTML = '<div class="grid-cell time-label">Horário</div>';
            salasDisponiveis.forEach((sala, index) => {
                const status = getStatusSala(sala.id);
                const statusStyle = status.classe === 'em-uso' ? 'color: #D62828; font-weight: bold;' : 'opacity: 0.8;';
                headerHTML += `
                    <div class="grid-cell" style="background: ${sala.cor};">
                        <div class="sala-header">
                            <div class="sala-nome">${sala.nome}</div>
                            <div class="sala-status">${sala.tipo}</div>
                            <div class="sala-uso" style="font-size: 0.7rem; margin-top: 2px; ${statusStyle}">${status.texto}</div>
                        </div>
                    </div>
                `;
            });
            gridHeader.innerHTML = headerHTML;

            gridBody.innerHTML = '';

            // Atualizar grid-row para número dinâmico de salas
            const styleRow = document.createElement('style');
            styleRow.textContent = `.grid-row { grid-template-columns: 100px repeat(${numSalas}, 1fr); }`;
            gridBody.appendChild(styleRow);

            horarios.forEach(horario => {
                const row = document.createElement('div');
                row.className = 'grid-row';

                const timeCell = document.createElement('div');
                timeCell.className = 'time-cell';
                timeCell.textContent = horario;
                row.appendChild(timeCell);

                salasDisponiveis.forEach(sala => {
                    const appointmentCell = document.createElement('div');
                    appointmentCell.className = 'appointment-cell';
                    appointmentCell.dataset.sala = sala.id;
                    appointmentCell.dataset.horario = horario;

                    appointmentCell.addEventListener('dragover', handleDragOver);
                    appointmentCell.addEventListener('drop', handleDrop);

                    // Buscar agendamento considerando horários quebrados (normaliza para o slot)
                    const agendamento = agendamentos.find(a => {
                        if (a.sala !== sala.id || a.status === 'cancelado') return false;
                        if (!mesmaData(a.data, estadoAtual.dataAtual)) return false;
                        // Verifica horário exato OU horário normalizado
                        const horarioNormalizado = normalizarHorarioParaSlot(a.horario);
                        return a.horario === horario || horarioNormalizado === horario;
                    });

                    if (modoVisualizacao === 'agendados') {
                        // Modo agendados: mostra os agendamentos
                        if (agendamento) {
                            const appointmentDiv = criarElementoAgendamento(agendamento);
                            appointmentCell.appendChild(appointmentDiv);
                        }
                    } else {
                        // Modo livres: mostra indicador de disponível/ocupado
                        if (agendamento) {
                            // Ocupado
                            appointmentCell.style.background = 'rgba(214, 40, 40, 0.1)';
                            appointmentCell.innerHTML = `
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--vta-orange-dark); font-size: 0.8rem;">
                                    <i class="fas fa-times-circle" style="margin-right: 5px;"></i> Ocupado
                                </div>
                            `;
                        } else {
                            // Disponível
                            appointmentCell.style.background = 'rgba(82, 183, 136, 0.1)';
                            appointmentCell.innerHTML = `
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--vta-green); font-size: 0.8rem;">
                                    <i class="fas fa-check-circle" style="margin-right: 5px;"></i> Disponível
                                </div>
                            `;
                        }
                    }

                    appointmentCell.onclick = (e) => {
                        if (e.target === appointmentCell || e.target.closest('.appointment-cell') === appointmentCell) {
                            if (!agendamento) {
                                selecionarHorario(sala.id, horario);
                            }
                        }
                    };

                    row.appendChild(appointmentCell);
                });

                gridBody.appendChild(row);
            });
        }

        function renderizarGradeSemana() {
            const gridHeader = document.getElementById('gridHeader');
            const gridBody = document.getElementById('agendaGridBody');

            gridHeader.className = 'week-grid-header';
            gridBody.className = 'grid-body';
            gridBody.style.maxHeight = '600px';
            gridBody.style.overflowY = 'auto';

            const inicioSemana = getInicioSemana(estadoAtual.dataAtual);
            const diasUteis = [];
            for (let i = 1; i <= 5; i++) {
                const dia = new Date(inicioSemana);
                dia.setDate(inicioSemana.getDate() + i);
                diasUteis.push(dia);
            }

            gridHeader.style.display = 'grid';
            gridHeader.style.gridTemplateColumns = '100px repeat(5, 1fr)';
            gridHeader.style.background = 'var(--vta-green)';
            gridHeader.style.color = 'var(--white)';
            gridHeader.innerHTML = '<div class="grid-cell time-label">Sala</div>';

            const nomesDias = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex'];
            diasUteis.forEach((dia, index) => {
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-cell week-day-header';
                headerCell.innerHTML = `
                    <div class="dia-header">
                        <div class="dia-nome">${nomesDias[index]}</div>
                        <div class="dia-data">${dia.getDate()}/${dia.getMonth() + 1}</div>
                    </div>
                `;
                gridHeader.appendChild(headerCell);
            });

            gridBody.innerHTML = '';

            // Usar salas dinâmicas
            salasDisponiveis.forEach(sala => {
                const row = document.createElement('div');
                row.className = 'week-grid-row';

                const salaCell = document.createElement('div');
                salaCell.className = 'time-cell';
                salaCell.style.borderLeft = `4px solid ${sala.cor}`;
                salaCell.innerHTML = `<strong>${sala.nome}</strong><br><small>${sala.tipo}</small>`;
                row.appendChild(salaCell);

                diasUteis.forEach(dia => {
                    const appointmentCell = document.createElement('div');
                    appointmentCell.className = 'appointment-cell';
                    appointmentCell.dataset.data = dia.toISOString();
                    appointmentCell.dataset.sala = sala.id;
                    appointmentCell.style.minHeight = '120px';

                    appointmentCell.addEventListener('dragover', handleDragOver);
                    appointmentCell.addEventListener('drop', handleDrop);

                    const agendamentosDaSala = agendamentos.filter(a =>
                        a.sala === sala.id &&
                        mesmaData(a.data, dia) &&
                        a.status !== 'cancelado'
                    );

                    agendamentosDaSala.sort((a, b) => a.horario.localeCompare(b.horario));

                    // Se tem agendamentos, criar visualização expansível
                    const todosHorarios = gerarHorarios();
                    // Considerar horários quebrados na verificação
                    const horariosAgendados = agendamentosDaSala.map(a => {
                        const normalizado = normalizarHorarioParaSlot(a.horario);
                        return normalizado;
                    });
                    const horariosLivres = todosHorarios.filter(h => !horariosAgendados.includes(h));

                    appointmentCell.classList.add('expandable');

                    if (modoVisualizacao === 'agendados') {
                        // VISUALIZAÇÃO: HORÁRIOS AGENDADOS
                        if (agendamentosDaSala.length > 0) {
                            const resumoDiv = document.createElement('div');
                            resumoDiv.className = 'horarios-resumo';
                            resumoDiv.style.background = sala.cor;
                            resumoDiv.innerHTML = `
                                <div class="contador-agendamentos">${agendamentosDaSala.length}</div>
                                <div class="icone-expandir">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            `;
                            appointmentCell.appendChild(resumoDiv);

                            const expandidoDiv = document.createElement('div');
                            expandidoDiv.className = 'horarios-expandidos';

                            agendamentosDaSala.forEach(agendamento => {
                                const horarioItem = document.createElement('div');
                                horarioItem.className = `horario-item`;
                                horarioItem.style.borderLeftColor = sala.cor;
                                horarioItem.innerHTML = `
                                    <div class="horario-tempo">${agendamento.horario}</div>
                                    <div class="horario-info">
                                        <div class="horario-pet">${agendamento.pet}</div>
                                        <div class="horario-cliente">${agendamento.cliente}</div>
                                    </div>
                                `;

                                horarioItem.onclick = (e) => {
                                    e.stopPropagation();
                                    mostrarDetalhesAgendamento(agendamento);
                                };

                                expandidoDiv.appendChild(horarioItem);
                            });

                            appointmentCell.appendChild(expandidoDiv);
                        }
                    } else {
                        // VISUALIZAÇÃO: HORÁRIOS LIVRES com cor da sala
                        if (horariosLivres.length > 0) {
                            const resumoDiv = document.createElement('div');
                            resumoDiv.className = 'horarios-resumo';
                            resumoDiv.style.background = sala.cor;
                            resumoDiv.style.opacity = '0.7';
                            resumoDiv.innerHTML = `
                                <div class="contador-agendamentos" style="font-size: 1.2rem;">${horariosLivres.length}</div>
                                <div class="icone-expandir">
                                    <i class="fas fa-clock"></i>
                                </div>
                            `;
                            appointmentCell.appendChild(resumoDiv);

                            const expandidoDiv = document.createElement('div');
                            expandidoDiv.className = 'horarios-livres-lista';

                            horariosLivres.forEach(horario => {
                                const horarioItem = document.createElement('div');
                                horarioItem.className = 'horario-livre-item';
                                horarioItem.style.borderLeftColor = sala.cor;
                                horarioItem.innerHTML = `
                                    <div class="horario-livre-tempo">${horario}</div>
                                    <div class="horario-livre-status" style="color: ${sala.cor};">
                                        <i class="fas fa-check-circle"></i>
                                        Disponível
                                    </div>
                                `;

                                horarioItem.onclick = (e) => {
                                    e.stopPropagation();
                                    estadoAtual.dataAtual = new Date(dia);
                                    selecionarHorario(sala.id, horario);
                                };

                                expandidoDiv.appendChild(horarioItem);
                            });

                            appointmentCell.appendChild(expandidoDiv);
                        } else {
                            // Se não há horários livres, mostrar indicador
                            const vazioDiv = document.createElement('div');
                            vazioDiv.className = 'horarios-resumo';
                            vazioDiv.style.background = 'rgba(200, 200, 200, 0.3)';
                            vazioDiv.innerHTML = `
                                <div style="font-size: 0.8rem; opacity: 0.5; color: var(--gray-dark);">
                                    <i class="fas fa-ban"></i> Lotado
                                </div>
                            `;
                            appointmentCell.appendChild(vazioDiv);
                        }
                    }


                    appointmentCell.onclick = (e) => {
                        if (e.target === appointmentCell) {
                            estadoAtual.dataAtual = new Date(dia);
                            selecionarHorario(sala.id, '08:00');
                        }
                    };

                    row.appendChild(appointmentCell);
                });

                gridBody.appendChild(row);
            });
        }

        function renderizarGradeMes() {
            const gridHeader = document.getElementById('gridHeader');
            const gridBody = document.getElementById('agendaGridBody');

            gridHeader.className = 'grid-header';
            gridHeader.style.display = 'grid';
            gridHeader.style.gridTemplateColumns = 'repeat(7, 1fr)';
            gridHeader.style.background = 'var(--vta-green)';
            gridHeader.style.color = 'var(--white)';

            const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];

            gridHeader.innerHTML = '';
            diasSemana.forEach(dia => {
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-cell calendar-day-header';
                headerCell.textContent = dia;
                gridHeader.appendChild(headerCell);
            });

            gridBody.innerHTML = '';
            gridBody.className = 'calendar-body';
            gridBody.style.maxHeight = 'none';
            gridBody.style.overflowY = 'visible';

            const ano = estadoAtual.dataAtual.getFullYear();
            const mes = estadoAtual.dataAtual.getMonth();

            const primeiroDia = new Date(ano, mes, 1);
            const inicioCalendario = new Date(primeiroDia);
            inicioCalendario.setDate(primeiroDia.getDate() - primeiroDia.getDay());

            for (let semana = 0; semana < 6; semana++) {
                const row = document.createElement('div');
                row.className = 'calendar-week';

                for (let dia = 0; dia < 7; dia++) {
                    const dataAtual = new Date(inicioCalendario);
                    dataAtual.setDate(inicioCalendario.getDate() + (semana * 7) + dia);

                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day';

                    if (dataAtual.getMonth() !== mes) {
                        dayCell.classList.add('other-month');
                    }

                    const hoje = new Date();
                    if (mesmaData(dataAtual, hoje)) {
                        dayCell.classList.add('today');
                    }

                    const agendamentosNoDia = agendamentos.filter(a => mesmaData(a.data, dataAtual) && a.status !== 'cancelado');

                    // Contar agendamentos por sala
                    const contadoresPorSala = {
                        sala1: 0,
                        sala2: 0,
                        sala3: 0,
                        sala4: 0
                    };

                    agendamentosNoDia.forEach(a => {
                        if (contadoresPorSala.hasOwnProperty(a.sala)) {
                            contadoresPorSala[a.sala]++;
                        }
                    });

                    // Criar badges com nome da sala
                    let eventosHTML = '';
                    const nomeSalas = {
                        sala1: 'Consulta',
                        sala2: 'Cirurgia',
                        sala3: 'Raio-x',
                        sala4: 'Interanação'
                    };

                    const coresSalas = {
                        sala1: 'consulta',
                        sala2: 'cirurgia',
                        sala3: 'exame',
                        sala4: 'internacao'
                    };

                    Object.keys(contadoresPorSala).forEach(sala => {
                        if (contadoresPorSala[sala] > 0) {
                            eventosHTML += `
            <div class="event-group">
                <div class="event-label">${nomeSalas[sala]}</div>
                <div class="event-badge ${coresSalas[sala]}">${contadoresPorSala[sala]}</div>
            </div>
        `;
                        }
                    });

                    dayCell.innerHTML = `
                        <div class="day-number">${dataAtual.getDate()}</div>
                        <div class="day-events">${eventosHTML}</div>
                    `;

                    dayCell.onclick = () => selecionarDiaCalendario(dataAtual);

                    row.appendChild(dayCell);
                }

                gridBody.appendChild(row);
            }
        }

        function criarElementoAgendamento(agendamento, mostrarSala = false) {
            const appointmentDiv = document.createElement('div');
            const temCheckin = agendamento.checkin && agendamento.checkin.realizado;
            appointmentDiv.className = `appointment ${agendamento.sala} ${temCheckin ? 'checkin-realizado' : ''}`;
            appointmentDiv.draggable = true;
            appointmentDiv.dataset.id = agendamento.id;

            // Badge de check-in realizado
            const checkinBadge = temCheckin ? '<div class="appointment-checkin-badge"><i class="fas fa-check"></i></div>' : '';

            if (mostrarSala) {
                // Para expansões (semana) - mostra sala
                appointmentDiv.innerHTML = `
            ${checkinBadge}
            <div class="appointment-title">${agendamento.pet}</div>
            <div class="appointment-subtitle">${getNomeSala(agendamento.sala)}</div>
            <div class="appointment-time">${agendamento.horario}</div>
        `;
            } else {
                // Para grade normal (dia) - mostra cliente e horário
                appointmentDiv.innerHTML = `
            ${checkinBadge}
            <div class="appointment-title">${agendamento.cliente}</div>
            <div class="appointment-subtitle">${agendamento.pet} • ${agendamento.horario}</div>
        `;
            }

            appointmentDiv.addEventListener('dragstart', handleDragStart);
            appointmentDiv.addEventListener('dragend', handleDragEnd);
            appointmentDiv.onclick = (e) => {
                e.stopPropagation();
                mostrarDetalhesAgendamento(agendamento);
            };

            return appointmentDiv;
        }

        let draggedElement = null;
        let draggedAgendamento = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            const id = parseInt(e.target.dataset.id);
            draggedAgendamento = agendamentos.find(a => a.id === id);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();

            if (!draggedAgendamento) return;

            const cell = e.target.closest('.appointment-cell');
            if (!cell) return;

            let novaSala, novoHorario, novaData;

            if (estadoAtual.visualizacao === 'dia') {
                novaSala = cell.dataset.sala;
                novoHorario = cell.dataset.horario;
                novaData = estadoAtual.dataAtual;
            } else if (estadoAtual.visualizacao === 'semana') {
                novaSala = cell.dataset.sala;
                novoHorario = draggedAgendamento.horario;
                novaData = cell.dataset.data ? new Date(cell.dataset.data) : estadoAtual.dataAtual;
            }

            if (novaSala && novoHorario && novaData) {
                solicitarMovimentacao(draggedAgendamento, novaSala, novoHorario, novaData);
            }
        }

        function verificarHorarioOcupado(sala, data, horario, idIgnorar = null) {
            // Normaliza a data para objeto Date para usar a função mesmaData
            let dataObj;
            if (typeof data === 'string') {
                // Assume formato YYYY-MM-DD vindo do input
                dataObj = new Date(data + 'T00:00:00');
            } else {
                dataObj = data;
            }

            return agendamentos.some(a => {
                // Se estiver editando, ignora o próprio agendamento
                if (idIgnorar && a.id === idIgnorar) return false;
                
                // Verifica se é a mesma sala, mesmo horário e mesma data
                return a.sala === sala && 
                       a.horario === horario && 
                       mesmaData(a.data, dataObj) &&
                       a.status !== 'cancelado';
            });
        }

        function solicitarMovimentacao(agendamento, novaSala, novoHorario, novaData) {
            movimentacaoPendente = {
                agendamento: agendamento,
                novaSala: novaSala,
                novoHorario: novoHorario,
                novaData: novaData
            };

            const moverInfoBox = document.getElementById('moverInfoBox');
            moverInfoBox.innerHTML = `
                <div class="info-box-title">De:</div>
                <div class="info-box-text">
                    ${getNomeSala(agendamento.sala)}<br>
                    ${agendamento.data.toLocaleDateString('pt-BR')} às ${agendamento.horario}
                </div>
                <div class="info-box-title" style="margin-top: 1rem;">Para:</div>
                <div class="info-box-text">
                    ${getNomeSala(novaSala)}<br>
                    ${novaData.toLocaleDateString('pt-BR')} às ${novoHorario}
                </div>
            `;

            document.getElementById('confirmarMoverModal').classList.add('show');
        }

        // Função utilitária para formatar data local sem problemas de fuso horário
        function formatarDataParaBackend(data) {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        async function confirmarMovimentacao() {
            if (!movimentacaoPendente) return;

            const { agendamento, novaSala, novoHorario, novaData } = movimentacaoPendente;

            // VERIFICAÇÃO DE CONFLITO
            if (verificarHorarioOcupado(novaSala, novaData, novoHorario, agendamento.id)) {
                mostrarToast('Erro: Já existe um agendamento neste horário e sala!', 'error');
                fecharMover();
                return;
            }

            try {
                const response = await fetch(`/api/agendamentos/${agendamento.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sala: novaSala,
                        horario: novoHorario,
                        data: formatarDataParaBackend(novaData),
                        cliente: agendamento.cliente,
                        pet: agendamento.pet,
                        status: agendamento.status,
                        obs: agendamento.obs
                    })
                });

                if (!response.ok) throw new Error('Erro ao mover agendamento');

                await carregarAgendamentos();
                fecharMover();
                mostrarToast('Agendamento movido com sucesso!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao mover agendamento', 'error');
            }
        }

        function cancelarMovimentacao() {
            fecharMover();
        }

        function fecharMover() {
            document.getElementById('confirmarMoverModal').classList.remove('show');
            movimentacaoPendente = null;
            draggedElement = null;
            draggedAgendamento = null;
        }

        function selecionarDiaCalendario(data) {
            estadoAtual.dataAtual = new Date(data);
            estadoAtual.visualizacao = 'dia';

            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-view="dia"]').classList.add('active');

            atualizarPeriodo();
            renderizarGrade();
            mostrarToast(`Visualizando ${data.toLocaleDateString('pt-BR')}`, 'success');
        }

        function getNomeSala(salaId) {
            const sala = salasDisponiveis.find(s => s.id === salaId);
            return sala ? `${sala.nome} - ${sala.tipo}` : salaId;
        }

        function mostrarDetalhesAgendamento(agendamento) {
            const detalhesContent = document.getElementById('detalhesContent');
            const temCheckin = agendamento.checkin && agendamento.checkin.realizado;
            const sala = salasDisponiveis.find(s => s.id === agendamento.sala);
            const corSala = sala ? sala.cor : 'var(--vta-green)';

            // Status badges melhorados
            let statusHTML = '';
            const statusMap = {
                'agendado': { texto: 'AGENDADO', cor: 'var(--vta-orange)', icone: 'fa-calendar-check' },
                'confirmado': { texto: 'CONFIRMADO', cor: 'var(--vta-green)', icone: 'fa-check' },
                'cancelado': { texto: 'CANCELADO', cor: 'var(--vta-orange-dark)', icone: 'fa-times' },
                'concluido': { texto: 'CONCLUÍDO', cor: 'var(--vta-blue)', icone: 'fa-check-double' }
            };

            const statusInfo = statusMap[agendamento.status] || statusMap['agendado'];
            statusHTML = `
                <span class="status-badge" style="background: ${statusInfo.cor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;">
                    <i class="fas ${statusInfo.icone}"></i> ${statusInfo.texto}
                </span>
            `;

            if (temCheckin) {
                statusHTML += `
                    <span class="status-badge" style="background: var(--vta-green); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; margin-left: 0.5rem;">
                        <i class="fas fa-check-circle"></i> CHECK-IN ✓
                    </span>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-medium);">
                        📍 ${agendamento.checkin.data || ''} às ${agendamento.checkin.horario}
                    </div>
                `;
            }

            detalhesContent.innerHTML = `
                <div style="border-left: 4px solid ${corSala}; padding-left: 15px; margin-bottom: 15px;">
                    <div class="detail-group">
                        <div class="detail-label">Pet</div>
                        <div class="detail-value" style="font-size: 1.1rem; font-weight: 600;">${agendamento.pet}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Cliente</div>
                        <div class="detail-value">${agendamento.cliente}</div>
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Sala</div>
                    <div class="detail-value">
                        <span style="display: inline-flex; align-items: center; gap: 8px;">
                            <span style="width: 12px; height: 12px; border-radius: 50%; background: ${corSala};"></span>
                            ${getNomeSala(agendamento.sala)}
                        </span>
                    </div>
                </div>
                ${agendamento.profissional ? `
                <div class="detail-group">
                    <div class="detail-label">Profissional</div>
                    <div class="detail-value"><i class="fas fa-user-md" style="margin-right: 5px;"></i>${agendamento.profissional}</div>
                </div>
                ` : ''}
                <div class="detail-group">
                    <div class="detail-label">Data e Horário</div>
                    <div class="detail-value">
                        <i class="fas fa-calendar-alt" style="margin-right: 5px; color: ${corSala};"></i>
                        ${agendamento.data.toLocaleDateString('pt-BR')} às ${agendamento.horario}
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Status</div>
                    <div class="detail-value">
                        ${statusHTML}
                    </div>
                </div>
                <div class="detail-group">
                    <div class="detail-label">Observações</div>
                    <div class="detail-value">${agendamento.obs || 'Nenhuma observação'}</div>
                </div>
                <div class="modal-actions">
                    ${!temCheckin ? `
                        <button class="btn btn-primary" onclick="solicitarCheckin(${agendamento.id})" style="background: linear-gradient(135deg, #52B788, #74C69D); flex: 1;">
                            <i class="fas fa-check-circle"></i>
                            Check-in
                        </button>
                    ` : `
                        <button class="btn" onclick="desfazerCheckIn(${agendamento.id})" style="background: #E8E8E8; color: #666; flex: 1;">
                            <i class="fas fa-undo"></i>
                            Desfazer Check-in
                        </button>
                    `}
                    <button class="btn btn-secondary" onclick="editarAgendamento(${agendamento.id})" style="flex: 1;">
                        <i class="fas fa-edit"></i>
                        Editar
                    </button>
                    <button class="btn btn-delete-checkin" onclick="solicitarExclusao(${agendamento.id})" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        Excluir
                    </button>
                </div>
            `;

            document.getElementById('detalhesModal').classList.add('show');
        }

        function fecharDetalhes() {
            document.getElementById('detalhesModal').classList.remove('show');
        }

        // Funções para confirmação de check-in
        function solicitarCheckin(id) {
            agendamentoParaCheckin = agendamentos.find(a => a.id === id);
            if (!agendamentoParaCheckin) return;

            const salaConfig = salasDisponiveis.find(s => s.id === agendamentoParaCheckin.sala) || salasDisponiveis[0];
            const corSala = salaConfig.cor;

            const checkinInfoBox = document.getElementById('checkinInfoBox');
            checkinInfoBox.innerHTML = `
                <div class="info-box-title" style="color: ${corSala};">
                    <i class="fas fa-paw" style="margin-right: 8px;"></i>
                    ${agendamentoParaCheckin.pet}
                </div>
                <div class="info-box-subtitle">Tutor: ${agendamentoParaCheckin.cliente}</div>
                <div class="info-box-detail">
                    <i class="fas fa-calendar-alt"></i>
                    ${agendamentoParaCheckin.data.toLocaleDateString('pt-BR')} às ${agendamentoParaCheckin.horario}
                </div>
                <div class="info-box-detail">
                    <i class="fas fa-door-open"></i>
                    ${salaConfig.nome} - ${salaConfig.tipo}
                </div>
            `;

            fecharDetalhes();
            document.getElementById('confirmarCheckinModal').classList.add('show');
        }

        function fecharConfirmacaoCheckin() {
            document.getElementById('confirmarCheckinModal').classList.remove('show');
            agendamentoParaCheckin = null;
        }

        async function confirmarCheckinReal() {
            if (!agendamentoParaCheckin) return;

            const id = agendamentoParaCheckin.id;
            fecharConfirmacaoCheckin();
            await realizarCheckIn(id);
        }

        async function realizarCheckIn(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;

            const agora = new Date();
            const horario = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const dataCheckin = agora.toLocaleDateString('pt-BR');

            try {
                const response = await fetch(`/api/agendamentos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        checkin: {
                            realizado: true,
                            horario: horario,
                            data: dataCheckin
                        }
                    })
                });

                if (!response.ok) throw new Error('Erro ao realizar check-in');

                await carregarAgendamentos();
                
                // Re-encontrar o agendamento atualizado para mostrar detalhes
                const agendamentoAtualizado = agendamentos.find(a => a.id === id);
                mostrarDetalhesAgendamento(agendamentoAtualizado);
                
                mostrarToast(`Bem-vindo! Check-in realizado para ${agendamentoAtualizado.pet}`, 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao realizar check-in', 'error');
            }
        }

        async function desfazerCheckIn(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;

            try {
                const response = await fetch(`/api/agendamentos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        checkin: null
                    })
                });

                if (!response.ok) throw new Error('Erro ao desfazer check-in');

                await carregarAgendamentos();
                
                const agendamentoAtualizado = agendamentos.find(a => a.id === id);
                mostrarDetalhesAgendamento(agendamentoAtualizado);
                
                mostrarToast('Check-in cancelado', 'warning');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao desfazer check-in', 'error');
            }
        }

        function editarAgendamento(id) {
            agendamentoEditando = agendamentos.find(a => a.id === id);
            if (!agendamentoEditando) return;

            document.getElementById('modalTitle').textContent = 'Editar Agendamento';

            // Para edição, definir o cliente e carregar seus pets
            const clienteSelect = document.getElementById('clienteSelect');
            clienteSelect.value = agendamentoEditando.cliente;

            // Carregar pets do cliente e depois selecionar o pet correto
            carregarPetsDoCliente(agendamentoEditando.cliente).then(() => {
                document.getElementById('petSelect').value = agendamentoEditando.pet;
            });

            document.getElementById('salaSelect').value = agendamentoEditando.sala;
            document.getElementById('profissionalSelect').value = agendamentoEditando.profissional || '';
            document.getElementById('obsTextarea').value = agendamentoEditando.obs;

            const ano = agendamentoEditando.data.getFullYear();
            const mes = String(agendamentoEditando.data.getMonth() + 1).padStart(2, '0');
            const dia = String(agendamentoEditando.data.getDate()).padStart(2, '0');
            document.getElementById('dataHoraInput').value = `${ano}-${mes}-${dia}T${agendamentoEditando.horario}`;

            document.getElementById('btnEditarAgendamento').style.display = 'none';
            const form = document.getElementById('agendamentoForm');
            form.querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = false;
            });

            fecharDetalhes();
            document.getElementById('agendamentoModal').classList.add('show');
        }

        function solicitarExclusao(id) {
            agendamentoParaExcluir = agendamentos.find(a => a.id === id);

            if (!agendamentoParaExcluir) return;

            const confirmInfoBox = document.getElementById('confirmInfoBox');
            confirmInfoBox.innerHTML = `
                <div class="info-box-title">${agendamentoParaExcluir.pet}</div>
                <div class="info-box-text">
                    Cliente: ${agendamentoParaExcluir.cliente}<br>
                    ${agendamentoParaExcluir.data.toLocaleDateString('pt-BR')} às ${agendamentoParaExcluir.horario}
                </div>
            `;

            fecharDetalhes();
            document.getElementById('confirmarExclusaoModal').classList.add('show');
        }

        function fecharConfirmacao() {
            document.getElementById('confirmarExclusaoModal').classList.remove('show');
            agendamentoParaExcluir = null;
        }

        async function confirmarExclusao() {
            if (!agendamentoParaExcluir) return;

            try {
                const response = await fetch(`/api/agendamentos/${agendamentoParaExcluir.id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Erro ao excluir agendamento');

                await carregarAgendamentos();
                fecharConfirmacao();
                mostrarToast('Agendamento excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao excluir agendamento', 'error');
            }
        }
        function selecionarHorario(sala, horario) {
            novoAgendamento(sala, horario);
        }

        function novoAgendamento(sala = '', horario = '') {
            agendamentoEditando = null;
            document.getElementById('modalTitle').textContent = 'Novo Agendamento';
            document.getElementById('agendamentoForm').reset();
            document.getElementById('btnEditarAgendamento').style.display = 'none';

            const form = document.getElementById('agendamentoForm');
            form.querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = false;
            });

            // Resetar select de pets
            const petSelect = document.getElementById('petSelect');
            petSelect.innerHTML = '<option value="">Selecione um pet</option>';

            // Recarregar clientes para garantir lista atualizada
            carregarClientes();

            const salaSelect = document.getElementById('salaSelect');
            const dataHoraInput = document.getElementById('dataHoraInput');

            if (sala && salaSelect) {
                salaSelect.value = sala;
            }

            const ano = estadoAtual.dataAtual.getFullYear();
            const mes = String(estadoAtual.dataAtual.getMonth() + 1).padStart(2, '0');
            const dia = String(estadoAtual.dataAtual.getDate()).padStart(2, '0');
            const horaUsar = horario || '08:00';
            dataHoraInput.value = `${ano}-${mes}-${dia}T${horaUsar}`;

            document.getElementById('agendamentoModal').classList.add('show');
        }

        function fecharModal() {
            document.getElementById('agendamentoModal').classList.remove('show');
            agendamentoEditando = null;
        }


        function abrirEdicao() {
            const form = document.getElementById('agendamentoForm');
            form.querySelectorAll('input, select, textarea').forEach(el => {
                el.disabled = false;
            });
            document.getElementById('btnEditarAgendamento').style.display = 'none';
            mostrarToast('Agora você pode editar o agendamento', 'info');
        }

        function buscarAgendamento() {
            document.getElementById('buscarModal').classList.add('show');
            document.getElementById('resultadosBusca').style.display = 'none';
        }

        function fecharBuscar() {
            document.getElementById('buscarModal').classList.remove('show');
            document.getElementById('buscarForm').reset();
            document.getElementById('resultadosBusca').style.display = 'none';
        }

        function realizarBusca() {
            const termoBusca = document.getElementById('buscaInput').value.toLowerCase();
            const salaFiltro = document.getElementById('buscaSalaSelect').value;
            const dataFiltro = document.getElementById('buscaDataInput').value;

            let resultados = agendamentos.filter(a => {
                let match = true;

                if (termoBusca) {
                    match = match && (
                        a.cliente.toLowerCase().includes(termoBusca) ||
                        a.pet.toLowerCase().includes(termoBusca)
                    );
                }

                if (salaFiltro) {
                    match = match && a.sala === salaFiltro;
                }

                if (dataFiltro) {
                    const dataBusca = new Date(dataFiltro);
                    match = match && mesmaData(a.data, dataBusca);
                }

                return match;
            });

            const listaResultados = document.getElementById('listaResultados');
            const resultadosDiv = document.getElementById('resultadosBusca');

            if (resultados.length === 0) {
                listaResultados.innerHTML = '<p style="color: var(--gray-medium); text-align: center;">Nenhum agendamento encontrado.</p>';
            } else {
                listaResultados.innerHTML = resultados.map(a => `
                    <div style="padding: 1rem; background: var(--gray-light); border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer;" onclick="irParaAgendamento(${a.id})">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${a.pet} - ${a.cliente}</div>
                        <div style="font-size: 0.9rem; color: var(--gray-medium);">
                            ${getNomeSala(a.sala)} | ${a.data.toLocaleDateString('pt-BR')} às ${a.horario}
                        </div>
                    </div>
                `).join('');
            }

            resultadosDiv.style.display = 'block';
        }

        function irParaAgendamento(id) {
            const agendamento = agendamentos.find(a => a.id === id);
            if (!agendamento) return;

            estadoAtual.dataAtual = new Date(agendamento.data);
            estadoAtual.visualizacao = 'dia';

            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-view="dia"]').classList.add('active');

            fecharBuscar();
            atualizarPeriodo();
            renderizarGrade();

            setTimeout(() => {
                mostrarDetalhesAgendamento(agendamento);
            }, 300);
        }

        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--vta-green);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 2000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;

            if (tipo === 'success') toast.style.background = 'var(--vta-green)';
            if (tipo === 'warning') toast.style.background = 'var(--vta-orange)';
            if (tipo === 'error') toast.style.background = 'var(--vta-orange-dark)';
            if (tipo === 'info') toast.style.background = 'var(--vta-blue)';

            toast.textContent = mensagem;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                estadoAtual.visualizacao = this.dataset.view;
                atualizarPeriodo();
                renderizarGrade();
            });
        });

        document.getElementById('agendamentoForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const clienteSelect = document.getElementById('clienteSelect');
            const petSelect = document.getElementById('petSelect');
            const salaSelect = document.getElementById('salaSelect');
            const profissionalSelect = document.getElementById('profissionalSelect');
            const dataHoraInput = document.getElementById('dataHoraInput');
            const obsTextarea = document.getElementById('obsTextarea');

            // Validar seleção de cliente e pet
            if (!clienteSelect.value) {
                mostrarToast('Por favor, selecione um cliente', 'error');
                return;
            }
            if (!petSelect.value) {
                mostrarToast('Por favor, selecione um pet', 'error');
                return;
            }

            const dataHora = new Date(dataHoraInput.value);
            const horario = dataHoraInput.value.split('T')[1];
            const dataStr = dataHoraInput.value.split('T')[0];

            // VERIFICAÇÃO DE CONFLITO
            const idIgnorar = agendamentoEditando ? agendamentoEditando.id : null;
            if (verificarHorarioOcupado(salaSelect.value, dataStr, horario, idIgnorar)) {
                mostrarToast('Erro: Já existe um agendamento neste horário e sala!', 'error');
                return; // Interrompe o salvamento
            }

            try {
                if (agendamentoEditando) {
                    const response = await fetch(`/api/agendamentos/${agendamentoEditando.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cliente: clienteSelect.value,
                            pet: petSelect.value,
                            sala: salaSelect.value,
                            profissional: profissionalSelect.value || null,
                            data: dataStr,
                            horario: horario,
                            status: agendamentoEditando.status,
                            obs: obsTextarea.value
                        })
                    });

                    if (!response.ok) throw new Error('Erro ao atualizar agendamento');
                    mostrarToast('Agendamento atualizado com sucesso!', 'success');
                } else {
                    const response = await fetch('/api/agendamentos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cliente: clienteSelect.value,
                            pet: petSelect.value,
                            sala: salaSelect.value,
                            profissional: profissionalSelect.value || null,
                            data: dataStr,
                            horario: horario,
                            status: "agendado",
                            obs: obsTextarea.value
                        })
                    });

                    if (!response.ok) throw new Error('Erro ao criar agendamento');
                    mostrarToast('Agendamento criado com sucesso!', 'success');
                }

                await carregarAgendamentos();
                fecharModal();
                this.reset();
            } catch (error) {
                console.error('Erro:', error);
                mostrarToast('Erro ao salvar agendamento', 'error');
            }
        });

        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        // Carregar agendamentos salvos
        carregarAgendamentos();

        atualizarPeriodo();
        // renderizarGrade(); // carregarAgendamentos já chama renderizarGrade

        // Função alternarVisualizacaoSemana removida - usar alternarVisualizacao() que é unificada

        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                window.location.href = '/logout';
            }
        }

    </script>
</body>

</html>